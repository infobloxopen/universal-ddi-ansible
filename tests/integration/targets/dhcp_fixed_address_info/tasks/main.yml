---
- module_defaults:
    group/infoblox.universal_ddi.all:
      portal_url: "{{ portal_url }}"
      portal_key: "{{ portal_key }}"

  block:
    # Create a Fixed Address
    - name: Create a Fixed Address
      infoblox.universal_ddi.dhcp_fixed_address:
        address: "10.0.0.1"
        name: "test_fixed_address_ansible"
        match_type: "mac"
        match_value: "00:00:00:00:00:00"
        ip_space: "{{ _ip_space.id }}"
        state: "present"
      register: fixed_address

    # Get information about the Fixed Address
    - name: Get information about the Fixed Address using ID
      infoblox.universal_ddi.dhcp_fixed_address_info:
        id: "{{ fixed_address.id }}"
      register: fixed_address_info
    - assert:
        that:
          - fixed_address_info.objects | length == 1
          - fixed_address_info.objects[0].id == fixed_address.id
          - fixed_address_info.objects[0].address == fixed_address.object.address

    - name: Get information about the Fixed Address
      infoblox.universal_ddi.dhcp_fixed_address_info:
        filters:
          address: "10.0.0.1"
          ip_space: "{{ _ip_space.id }}"
      register: fixed_address_info
    - assert:
        that:
          - fixed_address_info.objects | length == 1
          - fixed_address_info.objects[0].id == fixed_address.id
          - fixed_address_info.objects[0].address == fixed_address.object.address

    # Test idempotency of Fixed Address Info
    - name: Get Fixed Address Info (idempotent)
      infoblox.universal_ddi.dhcp_fixed_address_info:
        filters:
          address: "10.0.0.1"
          ip_space: "{{ _ip_space.id }}"
      register: fixed_address_info
    - assert:
        that:
          - fixed_address_info.objects | length == 1
          - fixed_address_info.objects[0].id == fixed_address.id
          - fixed_address_info.objects[0].address == fixed_address.object.address

    # Delete the Fixed Address
    - name: Delete a Fixed Address
      infoblox.universal_ddi.dhcp_fixed_address:
        address: "10.0.0.1"
        ip_space: "{{ _ip_space.id }}"
        match_type: "mac"
        match_value: "00:00:00:00:00:00"
        state: "absent"
      register: fixed_address

    # Verify the Fixed Address is deleted
    - name: Get information about the Fixed Address
      infoblox.universal_ddi.dhcp_fixed_address_info:
        filters:
          address: "10.0.0.1"
          ip_space: "{{ _ip_space.id }}"
      register: fixed_address_info
    - assert:
        that:
          - fixed_address_info.objects | length == 0

  always:
    - name: Delete IP Space
      ansible.builtin.include_role:
        name: setup_ip_space
        tasks_from: cleanup.yml